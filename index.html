<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Drum Patterns</title>
    <script src="rawinflate.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css?family=Montserrat&display=swap');
        :root {
            font-family: Montserrat, sans-serif;
        }
        .cgrid {
            display: inline-block;
            flex-basis: 40vw;
        }
        path, circle {
            stroke-width: 0.1;
            stroke: #000;
        }
        circle {
            fill: none;
        }
        use {
            opacity: 0.6;
        }
        #beatCards {
            display: grid;
            flex-basis: 60vw;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            grid-gap: 6px;
            padding: 6px;
        }
        #beatCards>ul {
            background-color: cornsilk;
            padding: 12px;
        }
        li {
            list-style: none;
            padding-left: 1rem;
            position: relative;
        }
        li.current::before {
            content:"*";
            position: absolute;
            left: 0;
            top: -3px;
            font-size: 1.8rem;
            font-weight: bold;;
        }
        main {
            display: flex;
        }
        #beatCards>ul {
            box-shadow: 0 12px 13px -8px;
        }
        #beatCards>ul::before {
            content: attr(data-group-name);
            font-size: 1.2rem;
            font-weight: bold;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>Drum Patterns</h1>
    <main>
    <div class="cgrid">
        <svg xmlns:svg="http://www.w3.org/2000/svg"
        viewBox="0 0 12.741451 12.741451"
             >
            <def>
            <path id="p0" d="m 6.4569328,0.05544 v 0.66495 c 0.729332,0.006 1.425513,0.15132 2.063301,0.4105 0.173808,-0.41797 0.02135,-0.0513 0.255499,-0.6144 -0.716411,-0.29178 -1.49889,-0.45494 -2.3188,-0.46105 z"
                style="fill:Red;stroke:#C00;stroke-width:0.07" />
            <path id="p1" d="m 6.4569328,0.79127 v 0.65224 c 0.630938,0.006 1.233197,0.13188 1.785459,0.3555 0.117796,-0.28328 0.08585,-0.20643 0.250703,-0.60288 C 7.8637268,0.94055 7.1767018,0.79735 6.4569328,0.79127 Z"
                style="fill:#0F0;stroke:#0C0;stroke-width:0.07" />
            <path id="p2" d="m 6.4569328,1.51471 v 0.6522 c 0.532525,0.006 1.041071,0.11187 1.507779,0.29993 0.07714,-0.18551 0.137308,-0.33026 0.250541,-0.60256 -0.543838,-0.22001 -1.13695,-0.34353 -1.75832,-0.34957 z"
                style="fill:#00F;stroke:#00C;stroke-width:0.07" />
            <path id="p3" d="m 6.4569328,2.23789 v 0.65207 c 0.434132,0.006 0.848909,0.0921 1.230068,0.24467 0.04864,-0.11697 0.1767,-0.42497 0.250508,-0.60246 -0.45829,-0.18444 -0.957605,-0.2883 -1.480576,-0.29428 z"
                style="fill:cyan;stroke:#0CC;stroke-width:0.07" />
            <path id="p4" d="M 6.4569328,2.96101 V 3.6077 c 0.336493,0.006 0.658182,0.0725 0.954411,0.18977 C 7.4434138,3.72027 7.6137098,3.31091 7.6598298,3.2 7.2870898,3.05108 6.8815098,2.9669 6.4569328,2.96101 Z"
                style="fill:magenta;stroke:#C0C;stroke-width:0.07" />
            <path id="p5" d="m 6.4569328,3.67861 v 0.6611 c 0.236943,0.005 0.46363,0.0526 0.673208,0.134 0.02837,-0.0682 0.222252,-0.53447 0.254064,-0.61097 -0.287817,-0.1137 -0.600334,-0.17836 -0.927272,-0.18413 z"
                style="fill:yellow;stroke:#CC0;stroke-width:0.07" />
            <path id="p6" d="M 6.4569328,4.41063 V 5.055 c 0.139735,0.005 0.273714,0.0328 0.398531,0.0794 0.03527,-0.0848 0.219665,-0.52828 0.247539,-0.59532 -0.201167,-0.0779 -0.418682,-0.1229 -0.64607,-0.12844 z"
                style="fill:darkorange;stroke:#C60;stroke-width:0.07" />
            </def>
            <g id="beats"></g>
            <g>
                <path d="M 6.3707248,5.1393722 V 0.04881222" />
                <path d="M 6.3707248,12.692652 V 7.6020822" />
                <path d="M 7.6020738,6.3707222 H 12.69265" />
                <path d="M 0.04880175,6.3707222 H 5.1393775" />
                <path d="M 5.5000301,5.5000322 1.9004497,1.9004522" />
                <path d="M 10.841,10.841012 7.2414198,7.2414222" />
                <path d="m 7.2414208,5.5000322 3.5995802,-3.59958" />
                <path d="M 1.9004505,10.841012 5.5000313,7.2414222" />
                <path d="M 5.8995088,5.2331122 3.9514296,0.53003222" />
                <path d="M 8.7900208,12.211432 6.8419418,7.5083522" />
                <path d="m 7.5083438,5.8995122 4.7030782,-1.94808" />
                <path d="M 0.53002965,8.7900322 5.2331084,6.8419422" />
                <path d="M 5.2331074,5.8995122 0.53002895,3.9514322" />
                <path d="M 12.211421,8.7900322 7.5083418,6.8419422" />
                <path d="M 6.8419428,5.2331122 8.7900218,0.53003222" />
                <path d="M 3.9514305,12.211432 5.8995098,7.5083522" />
                <circle r="1.2625618" cy="6.3707252" cx="6.3707256"/>
                <circle cx="6.3707256" cy="6.3707252" r="1.953192" />
                <circle r="2.6895306" cy="6.3707252" cx="6.3707256"/>
                <circle cx="6.3707256" cy="6.3707252" r="3.4149685" />
                <circle r="4.1266041" cy="6.3707252" cx="6.3707256"/>
                <circle cx="6.3707256" cy="6.3707252" r="4.8578873" />
                <circle r="5.5733833" cy="6.3707252" cx="6.3707256"/>
                <circle cx="6.3707256" cy="6.3707252" r="6.3075409" />
            </g>
        </svg>
    </div>
    <div id="beatCards"></div>
    </main>
    <script>
    function updateBeats(beatArray){
        beats.textContent="";
        beatArray.forEach(b=>{
            b = b.split(",");
            var beatId = "#"+b.splice(0,1)[0];
            b.forEach(num=>{
                var be = document.createElementNS( "http://www.w3.org/2000/svg", "use");
                be.setAttributeNS("http://www.w3.org/1999/xlink", "xlink:href", beatId);
                be.setAttributeNS("", "transform", `rotate(${num*22.5-22.5} 6.3707255 6.3707255)`);
                beats.appendChild(be);
            });
        });
    }

    function getBeats(node, xmlDoc){
        // start with the xml node 3 rows below the beat title merged cells
        let brow = ((node[1]>>0)+3);
        var inst = 0;
        const restvals = new Set(["20","8"]);
        var bb = [];
        while (inst<7){
            let key = node[0]+brow;
            let i=1, nnode = xmlDoc.querySelector(`c[r=${key}]`);
            if (!nnode)
                break;
            // do we want the instrument name???
            let nodetext = nnode.textContent;
            if (! nodetext)
                break; // probably not an instrument row
            var bbb = ["p"+inst];
            while (nnode = nnode.nextSibling){
                let rest = restvals.has(nnode.getAttribute("s"));
                if (!rest)
                    bbb.push(i);
                i++;
                if (i>16)
                    break;
            }
            bb.push(bbb.join(","));
            inst++;
            brow++;
        }
        return bb;
    }

    fetch("drum%20patterns.xlsx", {credentials: "same-origin"})
    .then(response=>response.arrayBuffer())
    .then(data=>{
        var bytes = new Uint8Array(data);
        data = String.fromCharCode.apply(null, bytes);
        var zdocs = readOfficeDoc( data );
        procXLXml(zdocs);
    });

    function procXLXml(xmldocs) {
        parser = new DOMParser();
        var tnode = document.createTextNode(decodeURIComponent(escape(xmldocs.strings.data)));    // trick, converts unicode to UTF-8
        var xmlStr = parser.parseFromString(tnode.textContent, "text/xml");
        var strings = Array.prototype.slice.call(xmlStr.querySelectorAll("si>t")).map(function (x) { return x.textContent });

        xmldocs.sheets.forEach(function (sh){
            var xmlDoc = parser.parseFromString(sh.data, "text/xml");
            var merged = Array.from(xmlDoc.querySelectorAll("mergeCell"), u=>u.getAttribute("ref").match(/([A-Z]{1,3})(\d{1,4}):([A-Z]{1,3})(\d{1,4})/).slice(1));
            merged = merged.sort((a,b)=>{
                if (a[0].length!=b[0].length)
                    return a[0].length - b[0].length;
                if (a[0]==b[0])
                    return a[1] - b[1]; // sort by row if same column
                return a[0].localeCompare(b[0])
            });
            merged.forEach(u=>{
                let key = u.slice(0,2).join("");
                let node = xmlDoc.querySelector(`c[r=${key}]>v`);
                if (node)
                u.push(strings[node.textContent>>0]);
            });
            var groups = Array.from(new Set(merged.map(u=>u[0])));
            groups.forEach(u=>{
                var bc = document.createElement("ul");
                var ourBeats = merged.filter(m=>m[0]==u);
                bc.dataset.groupName = ourBeats[0][4];
                ourBeats.slice(1).forEach(bx=>{
                    var ourbeat = document.createElement("li");
                    ourbeat.textContent = bx[4];
                    ourbeat.beats = getBeats(bx,xmlDoc);
                    ourbeat.onclick = function (e){
                        updateBeats(this.beats);
                        let old = beatCards.querySelector(".current");
                        if (old)
                            old.classList.remove("current");
                        this.classList.add("current");
                    };
                    bc.appendChild(ourbeat);
                });
                beatCards.appendChild(bc);
            });
        });


    }

    function readOfficeDoc(data) {
        // customised for excel, gets all sheets and the string table
        var EOCD = data.length - 22;
        if (data.substr(EOCD, 4) != "PK\05\06")
            return console.log("error locating EOCD");
        var i, numrecs = getInteger(data.substr(EOCD + 8, 2));
        var CD = getInteger(data.substr(EOCD + 16, 4));//data.charCodeAt(EOCD + 16) + (data.charCodeAt(EOCD + 17) << 8) + (data.charCodeAt(EOCD + 18) << 16) + (data.charCodeAt(EOCD + 19) << 24);
        if (data.substr(CD, 4) != "PK\01\02")
            return console.log("error locating CD");
        var entries = {sheets:[], strings:null};
        for (i = 0; i < numrecs; i++) {
            // get each entry
            var filenamelen = getInteger(data.substr(CD + 28, 2));
            var filename = data.substr(CD + 46, filenamelen);
            var isSheet = filename.match(/xl\/worksheets\/sheet\d.xml/);
            var isStrings = filename.match('xl/sharedStrings.xml')
            if (isSheet || isStrings) {
                var offset = getInteger(data.substr(CD + 42, 4)) + 30 + filenamelen;
                var compressedSize = getInteger(data.substr(CD + 20, 4));
                var fdata = data.substr(offset, compressedSize);
                if (data.charCodeAt(CD + 10) != 0)
                    fdata = RawDeflate.inflate(fdata);
                if (isSheet)
                    entries.sheets.push({ name: filename, data: fdata });
                else
                    entries.strings = { name: filename, data: fdata };
            }
            CD += (46 + filenamelen);
        }
        return entries;
    }
    function getInteger(chars) {
        for (var i = 0, result = 0; i < chars.length; i++)
            result += chars.charCodeAt(i) << (i * 8);
        return result;
    }

    </script>
</body>
</html>